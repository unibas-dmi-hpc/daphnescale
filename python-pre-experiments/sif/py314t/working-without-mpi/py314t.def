Bootstrap: docker
From: gcc:13

%labels
    Author YourName
    Version v1
    Description Python 3.14 (without GIL) + MPI4Py + VizTracer + NumPy + Score-P 9.3 (GCC base)

%environment
    export PATH=/opt/python314t/bin:/opt/scorep/bin:/usr/local/bin:/usr/bin:$PATH
    export LD_LIBRARY_PATH=/opt/scorep/lib:/usr/local/lib:/usr/lib:$LD_LIBRARY_PATH
    export PYTHONUNBUFFERED=1

%post
    set -eux

    echo "### Installing base packages..."
    apt-get update -y && apt-get install -y --no-install-recommends \
        wget curl git cmake ninja-build pkg-config make \
        libffi-dev libssl-dev libbz2-dev zlib1g-dev \
        libncurses-dev libsqlite3-dev liblzma-dev \
        libreadline-dev libgdbm-dev libnsl-dev ca-certificates \
        openmpi-bin libopenmpi-dev \
        libbfd-dev binutils-dev \
        && apt-get clean && rm -rf /var/lib/apt/lists/*

    echo "### Building Python 3.14 (without GIL) from source..."
    cd /tmp
    PY_VER=3.14.0
    wget -q https://www.python.org/ftp/python/${PY_VER}/Python-${PY_VER}.tgz
    tar xf Python-${PY_VER}.tgz && cd Python-${PY_VER}
    ./configure --disable-gil --prefix=/opt/python314t --enable-optimizations --enable-shared
    make -j"$(nproc)"
    make install

    echo "/opt/python314t/lib" > /etc/ld.so.conf.d/python314t.conf
    ldconfig

    echo "### Install core Python packages..."
    /opt/python314t/bin/pip3 install --no-cache-dir -U pip setuptools wheel

    # NumPy first (a lot of things like to see it)
    /opt/python314t/bin/pip3 install --no-cache-dir numpy

    echo "### Install mpi4py against container OpenMPI..."
    # This will detect /usr/bin/mpicc from libopenmpi-dev inside container
    OMPI_MPICC=/usr/bin/mpicc \
    /opt/python314t/bin/pip3 install --no-cache-dir --no-build-isolation mpi4py

    echo "### Install VizTracer and omp4py..."
    /opt/python314t/bin/pip3 install --no-cache-dir viztracer
    /opt/python314t/bin/pip3 install --no-cache-dir git+https://github.com/citiususc/omp4py.git

    echo "### Cleanup big build dirs (but NOT all of /tmp)..."
    rm -rf /tmp/Python-${PY_VER} /tmp/Python-${PY_VER}.tgz || true

    echo "### Building Score-P 9.3 (with OpenMPI + GOTCHA)..."
    mkdir -p /tmp/build/scorep && cd /tmp/build/scorep
    wget -L https://perftools.pages.jsc.fz-juelich.de/cicd/scorep/tags/scorep-9.3/scorep-9.3.tar.gz -O scorep-9.3.tar.gz
    tar xf scorep-9.3.tar.gz
    cd scorep-9.3
    ./configure --prefix=/opt/scorep \
                --with-mpi=openmpi \
                --with-libgotcha=download \
                --without-shmem \
                --without-cuda --without-rocm --without-opencl
    make -j"$(nproc)"
    make install
    cd / && rm -rf /tmp/build/scorep

    echo "### Installing Python bindings for Score-P..."
    export PATH=/opt/scorep/bin:$PATH
    export LD_LIBRARY_PATH=/opt/scorep/lib:/opt/python314/lib:$LD_LIBRARY_PATH
    /opt/python314t/bin/pip3 install --no-cache-dir scorep

    echo "### Cleanup..."
    rm -rf /root/.cache /var/lib/apt/lists/* || true

%runscript
    echo "Python 3.14 (GIL-disabled) + MPI4Py + VizTracer + NumPy + Score-P 9.3"
    exec /opt/python314t/bin/python "$@"

%help
Python 3.14 (without GIL) + MPI4Py + VizTracer + NumPy + Score-P 9.3 container.
Usage:
  singularity exec py314.sif python3 --version
  singularity exec py314.sif scorep --version
